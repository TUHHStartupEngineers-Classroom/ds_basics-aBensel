---
title: "01 Intro to the tidyverse"
author: "Artur Bensel"
date: "2021-04"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    collapsed: false
    number_sections: true
    toc_depth: 3
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

# Tidyverse

Last compiled: `r Sys.Date()`

## Sales by State
This section is pretty straight forward since it is basically the same as in section 6.1 from the tutorial. The column "location" was serpated into the two columns "city" and "state" before. It was then saved and can now be easily imported.


### Load libraries and read data
```{r}
library(tidyverse)
library(readxl)
library(lubridate)
library(ggplot2)


bike_orderlines_wrangled_tbl  <- read_excel(path = "ds_data/01_bike_sales/02_wrangled_data/bike_orderlines.xlsx")
```

### Data Wrangling

Group by state and then summarize the sales.

```{r}
sales_by_state_tbl <- bike_orderlines_wrangled_tbl %>%
  
  select(state, total_price) %>%
  
  group_by(state) %>% 
  summarize(sales = sum(total_price)) %>%

  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))
```

### Plot Data

```{r, fig.width=14, fig.height=10}
sales_by_state_tbl %>%
  
  ggplot(aes(x = state, y = sales)) +
  
  geom_col(fill = "#2DC6D6") +
  geom_label(aes(label = sales_text)) +
  
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  labs(
    title    = "Revenue by state",
    x = "",
    y = "Revenue"
  ) +
  
theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Sales by Year And State

Once again this part is very similar to section 6.2 from the tutorial and was thus implemented the same way.


### Data Wrangling

Select the columns and add a column called 'year'. Then group and summarize over both year and state.

```{r}
sales_by_year_state_tbl <- bike_orderlines_wrangled_tbl %>%
  
  select(order_date, total_price, state) %>%
  mutate(year = year(order_date)) %>%
  
  group_by(state, year) %>%
  summarise(sales = sum(total_price)) %>%
  ungroup() %>%
  
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €"))
```

### Plot Data

```{r, fig.width=14, fig.height=10}
sales_by_year_state_tbl %>%
  
  ggplot(aes(x = year, y = sales, fill = state)) +
  
  geom_col() +
  
  facet_wrap(~ state) +
  
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  labs(
    title = "Revenue by year and state",
    fill = "state"
  )+
  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
